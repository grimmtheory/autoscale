# -*- mode: ruby -*-
# vi: set ft=ruby :

VAGRANTFILE_API_VERSION = "2"
ENV['VAGRANT_DEFAULT_PROVIDER'] = 'virtualbox'

# Start config
Vagrant.configure(VAGRANTFILE_API_VERSION) do |config|

  # Global options

  # Turn on shared folders
  # config.vm.synced_folder "./", "/mnt/vagrant", disabled: true
  config.vm.synced_folder "./", "/mnt/vagrant"

  # Define instance - ubuntu1404 all-in-one devstack box configuration
  config.vm.define "ubuntu1404" do |ubuntu1404_config|

    # Provide box name, download url, etc.
    ubuntu1404_config.vm.hostname = "ubuntu1404"
    ubuntu1404_config.vm.box = "base"
    ubuntu1404_config.vm.box_url = "https://cloud-images.ubuntu.com/vagrant/trusty/current/trusty-server-cloudimg-amd64-vagrant-disk1.box"

    # Execute shell script within the new vm after it boots
    # ubuntu1404_config.vm.provision "shell", inline: $commonscript
    ubuntu1404_config.vm.provision "shell", path: "vagrant-post.sh"

    # Configure networking
    # eth0 - Default route / NAT
    # Auto-configured by Virtual Box

    # eth1 - API / management network
    ubuntu1404_config.vm.network "private_network", ip: "10.1.2.15"

    # eth2 - Neutron / bridge network
    ubuntu1404_config.vm.network "private_network", ip: "10.2.2.15"

    # eth3 - Public network (bridged adapter config if needed)
    # ubuntu1404_config.vm.network "public_network", :adapter => 4 , type: "dhcp", :bridge => 'en0: Wi-Fi (AirPort)'

    # Define extra vm options
    ubuntu1404_config.vm.provider "virtualbox" do |vb|
        # Don't boot in headless mode
        vb.gui = true
        # Set CPU and RAM
        vb.customize ["modifyvm", :id, "--memory", "2048"]
        vb.customize ["modifyvm", :id, "--cpus", "2"]
        # Enable promiscuous mode on neutron nic
        vb.customize ["modifyvm", :id, "--nicpromisc3", "allow-all"]
        # Set disk size, disabled for now requires local disk uuid to work
        # vb.customize ["modifyhd", "disk id", "--resize", "8192"]
        # Enable VT pass through
        vb.customize ["modifyvm", :id, "--hwvirtex", "on"]
        # vb.customize ["modifyvm", :id, "--ioapic", "on"]
    end

  end

end
